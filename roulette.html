<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë£°ë › ì´ë²¤íŠ¸</title>
  <style>
    body {
      font-family: 'Pretendard', sans-serif;
      text-align: center;
      background: #f0f0f0;
      margin: 0;
      padding: 40px;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    h1 {
      margin-bottom: 30px;
    }
    .roulette-wrapper {
      position: relative;
      width: 300px;
      height: 300px;
      margin: 0 auto 20px;
    }
    .wheel {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 10px solid #ccc;
      background: conic-gradient(
        #FFADAD 0deg 60deg,
        #FFD6A5 60deg 120deg,
        #FDFFB6 120deg 180deg,
        #CAFFBF 180deg 240deg,
        #9BF6FF 240deg 300deg,
        #A0C4FF 300deg 360deg
      );
      transition: transform 4s cubic-bezier(0.33, 1, 0.68, 1);
    }
    .pointer {
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 20px solid red;
    }
    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
      font-weight: bold;
      min-height: 24px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ë£°ë › ì´ë²¤íŠ¸</h1>
    <div class="roulette-wrapper">
      <div class="pointer"></div>
      <div class="wheel" id="wheel"></div>
    </div>
    <button id="spinBtn">ë£°ë › ëŒë¦¬ê¸°</button>
    <p id="result"></p>
  </div>

  <script>
    (function(){
      const userId = localStorage.getItem("userId");
      const userName = localStorage.getItem("name");
      const userTeam = localStorage.getItem("team");
      const spinBtn = document.getElementById("spinBtn");
      const resultEl = document.getElementById("result");
      const wheel = document.getElementById("wheel");

      // ë¡œê·¸ì¸ ì²´í¬
      if (!userId) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
        location.href = "index.html";
        return;
      }

      // ì´ë¯¸ ì°¸ì—¬í–ˆëŠ”ì§€ í™•ì¸
      if (localStorage.getItem("roulette_" + userId)) {
        resultEl.textContent = "ì´ë¯¸ ì°¸ì—¬í•˜ì…¨ìŠµë‹ˆë‹¤.";
        spinBtn.disabled = true;
      }

      const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwB1zmGi53EX-PhWIfcObxVsS-8wCYjYAAC9BSeQhGleTRWQYDzhZTDkIuKVWDFI_NBKQ/exec";

      spinBtn.addEventListener("click", function() {
        if (localStorage.getItem("roulette_" + userId)) return;

        spinBtn.disabled = true;
        resultEl.textContent = "ì¶”ì²¨ ì¤‘ì…ë‹ˆë‹¤...";

        fetch(GAS_WEBAPP_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: userId,
            name: userName,
            team: userTeam
          })
        })
        .then(response => {
          if (!response.ok) throw new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜');
          return response.json();
        })
        .then(data => {
          if (data.result === "success") {
            const sectorCount = 6;
            const sectorAngle = 360 / sectorCount;
            
            // ë‹¹ì²¨ëœ ìƒí’ˆì„ indexë¡œ ë§¤í•‘í•˜ê¸° ìœ„í•œ ê°„ë‹¨í•œ ë°©ë²•
            // ê²½í’ˆ ë°°ì—´ê³¼ ì‹¤ì œ ê°ë„ ë§¤í•‘ì€ ìƒí™©ì— ë§ê²Œ ì¡°ì • í•„ìš”
            // ì—¬ê¸°ì„  ëœë¤ìœ¼ë¡œ ëŒë¦¬ëŠ” ì• ë‹ˆë©”ì´ì…˜ì„ ìœ„í•´ ì„ì˜ë¡œ ì„¤ì •
            const prizeList = ["#FFADAD", "#FFD6A5", "#FDFFB6", "#CAFFBF", "#9BF6FF", "#A0C4FF"];
            let prizeIndex = prizeList.findIndex(color => color === data.prizeColor) // ì—†ìœ¼ë©´ -1
            
            // ë§Œì•½ prizeColorê°€ ì—†ë‹¤ë©´ ëœë¤ìœ¼ë¡œ fallback
            if (prizeIndex < 0) prizeIndex = Math.floor(Math.random() * sectorCount);

            // ì‹¤ì œ ê°ë„ ê³„ì‚° (5ë°”í€´ + ë‹¹ì²¨ ìœ„ì¹˜)
            const finalAngle = 360 * 5 + (360 - prizeIndex * sectorAngle - sectorAngle / 2);
            
            wheel.style.transition = "transform 4s cubic-bezier(0.33, 1, 0.68, 1)";
            wheel.style.transform = `rotate(${finalAngle}deg)`;

            setTimeout(() => {
              localStorage.setItem(
                "roulette_" + userId,
                `${userId},${data.prize},${new Date().toISOString()}`
              );
              resultEl.textContent = `${data.prize} ë‹¹ì²¨! ì¶•í•˜í•©ë‹ˆë‹¤ ğŸ‰`;
            }, 4200);
          } else {
            resultEl.textContent = data.message || "ê²½í’ˆì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤.";
            spinBtn.disabled = false;
          }
        })
        .catch(() => {
          resultEl.textContent = "ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          spinBtn.disabled = false;
        });
      });
    })();
  </script>
</body>
</html>
